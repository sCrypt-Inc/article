
# 使用 sCrypt 构建井字棋游戏 - 第二部分 第五小节

# 摘要 

* 调用合约
  * web3.call() 函数
  * 链式 APIs 
  * 构建调用合约的交易

## web3.call() 函数

部署好合约之后，接下来就是开始下棋了。每下一步棋，就是对合约的一次调用，并触发合约状态的改变。Web 应用程序与合约的交互主要发生在这个阶段。和部署合约一样，我们通过 web3 工具类提供的 web3.call() 来调用合约。

web3.call() 第一个参数是包含合约实例的 UTXO，作为构建调用合约的交易的第一个输入。第二个参数是一个回调函数。我们在 回调函数中使用[链式 APIs](https://github.com/sCrypt-Inc/scryptlib/blob/master/docs/chained_api_zh_CN.md) 来构建完整的调用合约的交易。

## 链式 APIs 

在部署合约和调用合约的过程中，通常需要计算交易费用和找零输出。在不知道解锁脚本大小的情况，很难准确地计算交易费用以及找零输出。scryptlib 扩展了 bsv 库， 提供一套链式 APIs 来构造交易。使得即使在这种情况下，计算交易费用和找零都变得简单。

> 操作打开链式 APIs 

## 构建调用合约的交易

调用合约需要完成以下工作:

1. 添加交易的输入。 从存储中取出包含合约实例的最新的 UTXO。作为交易的输入。
2. 添加交易的输出的。 根据游戏的状态和游戏规则来给交易添加输出。在此过程中， 使用 toContractState() 函数将游戏状态转换成合约状态。
3. 设置合约解锁脚本。解锁脚本包含两个两个重要的参数。分别是： preimage参数和 sig签名参数。 使用 scryptlib 提供的两个工具函数 getPreimage 和 signTx 计算。
4. 广播交易。使用钱包提供的 sendRawTransaction 接口广播交易。这封装在 web3.call() 函数中。
5. 更新合约状态。广播成功后，需要保存调用的交易和包含合约实例的UTXO, 作为下一次调用的输入。 同时还需要更新游戏状态和合约实例的状态。

> 操作下棋

至此，我们完成了 TicTacToe合约与 webapp 的交互，玩家的每个下棋动作，都产生一个区块链上的交易与之对应。


## 动手环节

1. 添加调用合约的代码。为每个下棋动作绑定一次合约调用。
2. 在将调用合约的交易发送到区块链网络之前，我们通常可以现在本地验证我们构建的交易是否有效。这个可以使用 scryptlib 提供的 verify 方法。

# 总结

这节课我们一起学习了如何构建交易来调用合约，以及 链式 APIs。

恭喜你，你已经成功完成前端页面与智能合约的交互。你已经具备开发dApp 的基础技能了。你太棒了！ 通过这两个节课，我们给你展示智能合约开发以及和智能合约交互的核心内容。如果你有兴趣，可以在这个井字棋dApp的基础上继续完善。比如：

1. 为它搭建一个后端服务，支持不同的玩家进行对战
2. 现在是在前端页面管理合约的 UTXO ，把它放到后端管理
3. 接入更多的钱包
4. 增加宫格，比如 5X5

本课程的代码开源在github上 [Tic-Tac-Toe: Bitcoin onchain App Tutorial](https://github.com/sCrypt-Inc/tic-tac-toe)

期待你构建出让人惊喜的dApp
